{"version":3,"sources":["../src/transformers/FileTransformer.ts"],"sourcesContent":["import ts from \"typescript\";\n\nimport { Singleton } from \"../utils/Singleton\";\n\nimport { IProject } from \"./IProject\";\nimport { NodeTransformer } from \"./NodeTransformer\";\nimport { TransformerError } from \"./TransformerError\";\n\nexport namespace FileTransformer {\n  export const transform =\n    (environments: Omit<IProject, \"context\">) =>\n    (context: ts.TransformationContext) =>\n    (file: ts.SourceFile): ts.SourceFile => {\n      if (file.isDeclarationFile) return file;\n\n      const project: IProject = {\n        ...environments,\n        context,\n      };\n      checkJsDocParsingMode.get(project, file);\n\n      return ts.visitEachChild(\n        file,\n        (node) => iterate_node(project)(node),\n        context,\n      );\n    };\n\n  const iterate_node =\n    (project: IProject) =>\n    (node: ts.Node): ts.Node =>\n      ts.visitEachChild(\n        try_transform_node(project)(node) ?? node,\n        (child) => iterate_node(project)(child),\n        project.context,\n      );\n\n  const try_transform_node =\n    (project: IProject) =>\n    (node: ts.Node): ts.Node | null => {\n      try {\n        return NodeTransformer.transform(project)(node);\n      } catch (exp) {\n        // ONLY ACCEPT TRANSFORMER-ERROR\n        if (!isTransformerError(exp)) throw exp;\n\n        // REPORT DIAGNOSTIC\n        const diagnostic = ts.createDiagnosticForNode(node, {\n          key: exp.code,\n          category: ts.DiagnosticCategory.Error,\n          message: exp.message,\n          code: `(${exp.code})` as any,\n        });\n        project.extras.addDiagnostic(diagnostic);\n        return null;\n      }\n    };\n}\n\nconst isTransformerError = (error: any): error is TransformerError =>\n  typeof error === \"object\" &&\n  error !== null &&\n  error.constructor.name === \"TransformerError\" &&\n  typeof error.code === \"string\" &&\n  typeof error.message === \"string\";\n\nconst checkJsDocParsingMode = new Singleton(\n  (project: IProject, file: ts.SourceFile) => {\n    if (\n      typeof file.jsDocParsingMode === \"number\" &&\n      file.jsDocParsingMode !== 0\n    ) {\n      project.extras.addDiagnostic(\n        ts.createDiagnosticForNode(file, {\n          code: `(typia setup)` as any,\n          key: \"jsDocParsingMode\",\n          category: ts.DiagnosticCategory.Warning,\n          message: [\n            `Run \"npx typia setup\" or \"npx typia patch\" command again.`,\n            ``,\n            `Since TypeScript v5.3 update, \"tsc\" no more parses JSDoc comments. Therefore, \"typia\" also cannot utilize those JSDoc comments too, and it damages on some features of \"typia\" like \"comment tags\" or \"JSON schema\" generator.`,\n            ``,\n            `To solve this problem, run \"npx typia setup\" or \"npx typia patch\" command to hack the TypeScript compiler to revive the JSDoc parsing feature.`,\n            ``,\n            `  - reference: https://github.com/microsoft/TypeScript/pull/55739`,\n          ].join(\"\\n\"),\n        }),\n      );\n    }\n  },\n);\n"],"mappings":";;;;;;;;;;;AAAA,OAAOA,QAAQ;;UAQEC,kBAAAA;mBACFC,YACX,CAACC,iBACD,CAACC,YACD,CAACC,SAAAA;AACC,QAAIA,KAAKC,kBAAmB,QAAOD;AAEnC,UAAME,UAAoB;MACxB,GAAGJ;MACHC;IACF;AACAI,0BAAsBC,IAAIF,SAASF,IAAAA;AAEnC,WAAOK,GAAGC,eACRN,MACA,CAACO,SAASC,aAAaN,OAAAA,EAASK,IAAAA,GAChCR,OAAAA;EAEJ;AAEF,QAAMS,eACJ,wBAACN,YACD,CAACK,SACCF,GAAGC,eACDG,mBAAmBP,OAAAA,EAASK,IAAAA,KAASA,MACrC,CAACG,UAAUF,aAAaN,OAAAA,EAASQ,KAAAA,GACjCR,QAAQH,OAAO,GALnB;AAQF,QAAMU,qBACJ,wBAACP,YACD,CAACK,SAAAA;AACC,QAAI;AACF,aAAOI,gBAAgBd,UAAUK,OAAAA,EAASK,IAAAA;IAC5C,SAASK,KAAK;AAEZ,UAAI,CAACC,mBAAmBD,GAAAA,EAAM,OAAMA;AAGpC,YAAME,aAAaT,GAAGU,wBAAwBR,MAAM;QAClDS,KAAKJ,IAAIK;QACTC,UAAUb,GAAGc,mBAAmBC;QAChCC,SAAST,IAAIS;QACbJ,MAAM,IAAIL,IAAIK,IAAI;MACpB,CAAA;AACAf,cAAQoB,OAAOC,cAAcT,UAAAA;AAC7B,aAAO;IACT;EACF,GAlBA;AAmBJ,GAjDiBlB,oBAAAA,kBAAAA,CAAAA,EAAAA;AAmDjB,IAAMiB,qBAAqB,wBAACW,UAC1B,OAAOA,UAAU,YACjBA,UAAU,QACVA,MAAMC,YAAYC,SAAS,sBAC3B,OAAOF,MAAMP,SAAS,YACtB,OAAOO,MAAMH,YAAY,UALA;AAO3B,IAAMlB,wBAAwB,IAAIwB,UAChC,CAACzB,SAAmBF,SAAAA;AAClB,MACE,OAAOA,KAAK4B,qBAAqB,YACjC5B,KAAK4B,qBAAqB,GAC1B;AACA1B,YAAQoB,OAAOC,cACblB,GAAGU,wBAAwBf,MAAM;MAC/BiB,MAAM;MACND,KAAK;MACLE,UAAUb,GAAGc,mBAAmBU;MAChCR,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACAS,KAAK,IAAA;IACT,CAAA,CAAA;EAEJ;AACF,CAAA;","names":["ts","FileTransformer","transform","environments","context","file","isDeclarationFile","project","checkJsDocParsingMode","get","ts","visitEachChild","node","iterate_node","try_transform_node","child","NodeTransformer","exp","isTransformerError","diagnostic","createDiagnosticForNode","key","code","category","DiagnosticCategory","Error","message","extras","addDiagnostic","error","constructor","name","Singleton","jsDocParsingMode","Warning","join"]}